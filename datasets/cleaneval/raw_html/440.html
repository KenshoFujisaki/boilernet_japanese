<html>
 <head> 
 </head> 
 <body> 
  <text encoding="iso-8859-1" id="http://www.freeswan.org/freeswan_trees/freeswan-1.99/doc/quickstart-firewall.html"> 
   <title>    &lt;span __num="0"&gt;     Introduction to FreeS/WAN    &lt;/span&gt;   </title> 
   <meta content="text/html; CHARSET=iso-8859-1" http-equiv="Content-Type"> 
   <style type="text/css">    <span __num="1">     &lt;!--BODY { font-family: serif }H1 { font-family: sans-serif }H2 { font-family: sans-serif }H3 { font-family: sans-serif }H4 { font-family: sans-serif }H5 { font-family: sans-serif }H6 { font-family: sans-serif }SUB { font-size: smaller }SUP { font-size: smaller }PRE { font-family: monospace }--&gt;    </span>   </style> 
   <a href="toc.html"> <span __num="2"> Contents </span> </a> 
   <a href="quickstart.html"> <span __num="3"> Previous </span> </a> 
   <a href="quickstart-configs.html"> <span __num="4"> Next </span> </a> 
   <hr> 
   <h1> <a name="quick_firewall"> <span __num="5" __label="true"> FreeS/WAN quick start on firewalling </span> </a> </h1> 
   <p> <span __num="6" __label="true"> This firewalling information supplements our </span> <a href="quickstart.html#quick_guide"> <span __num="7" __label="true"> quickstart guide. </span> </a> </p> 
   <p> <span __num="8" __label="true"> It includes tips for firewalling: </span> </p> 
   <ul> 
    <li> <a href="#firewall.standalone"> <span __num="9" __label="true"> a standalone system with initiator-only opportunism </span> </a> </li> 
    <li> <a href="#incoming.opp.firewall"> <span __num="10" __label="true"> incoming opportunistic connections </span> </a> </li> 
    <li> <a href="#opp.gate.firewall"> <span __num="11" __label="true"> an opportunistic gateway </span> </a> </li> 
   </ul> 
   <p> <span __num="12" __label="true"> and a list of helpful </span> <a href="#resources"> <span __num="13" __label="true"> resources </span> </a> <span __num="14" __label="true"> . </span> </p> 
   <h2> <a name="firewall.standalone"> <span __num="15" __label="true"> Firewalling a standalone system </span> </a> </h2> 
   <p> <span __num="16" __label="true"> Firewall rules on a standalone system doing IPsec can be very simple. </span> </p> 
   <p> <span __num="17" __label="true"> The first step is to allow IPsec packets (IKE on UDP port 500 plus ESP, protocol 50) in and out of your gateway. A script to set up iptables(8) rules for this is: </span> </p> 
   <pre><span __num="18" __label="true"># edit this line to match the interface you use as default route# ppp0 is correct for many modem, DSL or cable connections# but perhaps not for youworld=ppp0## allow IPsec## IKE negotiationsiptables -A INPUT  -p udp -i $world --sport 500 --dport 500 -j ACCEPTiptables -A OUTPUT -p udp -o $world --sport 500 --dport 500 -j ACCEPT# ESP encryption and authenticationiptables -A INPUT  -p 50 -i $world -j ACCEPTiptables -A OUTPUT -p 50 -o $world -j ACCEPT</span></pre> 
   <p> <span __num="19" __label="true"> Optionally, you could restrict this, allowing these packets only to and from a list of known gateways. </span> </p> 
   <p> <span __num="20" __label="true"> A second firewalling step -- access controls built into the IPsec protocols -- is automatically applied: </span> </p> 
   <dl> 
    <dt> 
     <a href="glossary.html#Pluto"> <span __num="21" __label="true"> Pluto </span> </a> 
     <span __num="22" __label="true"> -- the FreeS/WAN keying daemon -- deals with the IKE packets. </span> 
    </dt> 
    <dd> 
     <span __num="23" __label="true"> Pluto authenticates its partners during the IKE negotiation, and drops negotiation if authentication fails. </span> 
    </dd> 
    <dt> 
     <a href="glossary.html#KLIPS"> <span __num="24" __label="true"> KLIPS </span> </a> 
     <span __num="25" __label="true"> -- the FreeS/WAN kernel component -- handles the ESP packets. </span> 
    </dt> 
    <dd> 
     <dl> 
      <dt> 
       <span __num="26" __label="true"> KLIPS drops outgoing packets </span> 
      </dt> 
      <dd> 
       <span __num="27" __label="true"> if they are routed to IPsec, but no tunnel has been negotiated for them </span> 
      </dd> 
      <dt> 
       <span __num="28" __label="true"> KLIPS drops incoming unencrypted packets </span> 
      </dt> 
      <dd> 
       <span __num="29" __label="true"> if source and destination addresses match a tunnel; the packets should have been encrypted </span> 
      </dd> 
      <dt> 
       <span __num="30" __label="true"> KLIPS drops incoming encrypted packets </span> 
      </dt> 
      <dd> 
       <span __num="31" __label="true"> if source and destination address do not match the negotiated parameters of the tunnel that delivers them </span> 
      </dd> 
      <dd> 
       <span __num="32" __label="true"> if packet-level authentication fails </span> 
      </dd> 
     </dl> 
    </dd> 
   </dl> 
   <p> <span __num="33" __label="true"> These errors are logged. See our </span> <a href="trouble.html"> <span __num="34" __label="true"> troubleshooting </span> </a> <span __num="35" __label="true"> document for details. </span> </p> 
   <p> <span __num="36" __label="true"> As an optional third step, you may wish to filter packets emerging from your opportunistic tunnels. These packets arrive on an interface such as </span> <var> <span __num="37" __label="true"> ipsec0 </span> </var> <span __num="38" __label="true"> , rather than </span> <var> <span __num="39" __label="true"> eth0 </span> </var> <span __num="40" __label="true"> , </span> <var> <span __num="41" __label="true"> ppp0 </span> </var> <span __num="42" __label="true"> or whatever. For example, in an iptables(8) rule set, you would use: </span> </p> 
   <dl> 
    <dt> 
     <var> <span __num="43" __label="true"> -i ipsec+ </span> </var> 
    </dt> 
    <dd> 
     <span __num="44" __label="true"> to specify packets arriving on any ipsec device </span> 
    </dd> 
    <dt> 
     <var> <span __num="45" __label="true"> -o ipsec+ </span> </var> 
    </dt> 
    <dd> 
     <span __num="46" __label="true"> to specify packets leaving via any ipsec device </span> 
    </dd> 
   </dl> 
   <p> <span __num="47" __label="true"> In this way, you can apply whatever additional filtering you like to these packets. </span> </p> 
   <p> <span __num="48" __label="true"> The packets emerging on </span> <var> <span __num="49" __label="true"> ipsec0 </span> </var> <span __num="50" __label="true"> are likely to be things that a client application on your machine requested: web pages, e-mail, file transfers and so on. However, any time you initiate an opportunistic connection, you open a two-way connection to another machine (or network). It is conceivable that a Bad Guy there could take advantage of your link. </span> </p> 
   <p> <span __num="51" __label="true"> For more information, read the next section. </span> </p> 
   <h2> <a name="incoming.opp.firewall"> <span __num="52" __label="true"> Firewalling incoming opportunistic connections </span> </a> </h2> 
   <p> <span __num="53" __label="true"> The basic firewalling for IPsec does not change when you support incoming connections as well as connections you initiate. You must still allow IKE (UDP port 500) and ESP (protocol 50) packets to and from your machine, as in the rules given </span> <a href="#firewall.standalone"> <span __num="54" __label="true"> above </span> </a> <span __num="55" __label="true"> . </span> </p> 
   <p> <span __num="56" __label="true"> However, there is an additional security concern when you allow incoming opportunistic connections. Incoming opportunistic packets enter your machine via an IPSec tunnel. That is, they all appear as ESP (protocol 50) packets, concealing whatever port and protocol characteristics the packet within the tunnel has. Contained in the tunnel as they pass through </span> <var> <span __num="57" __label="true"> ppp0 </span> </var> <span __num="58" __label="true"> or </span> <var> <span __num="59" __label="true"> eth0 </span> </var> <span __num="60" __label="true"> , these packets can bypass your usual firewall rules on these interfaces. </span> </p> 
   <p> <span __num="61" __label="true"> Consequently, you will want to firewall your </span> <var> <span __num="62" __label="true"> ipsec </span> </var> <span __num="63" __label="true"> interfaces the way you would any publicly accessible interface. </span> </p> 
   <p> <span __num="64" __label="true"> A simple way to do this is to create one iptables(8) table with all your filtering rules for incoming packets, and apply the entire table to all public interfaces, including </span> <var> <span __num="65" __label="true"> ipsec </span> </var> <span __num="66" __label="true"> interfaces. </span> </p> 
   <h2> <a name="opp.gate.firewall"> <span __num="67" __label="true"> Firewalling for opportunistic gateways </span> </a> </h2> 
   <p> <span __num="68" __label="true"> On a gateway, the IPsec-related firewall rules applied for input and output on the Internet side are exactly as shown </span> <a href="#firewall.standalone"> <span __num="69" __label="true"> above </span> </a> <span __num="70" __label="true"> . A gateway exchanges exactly the same things -- UDP 500 packets and IPsec packets -- with other gateways that a standalone system does, so it can use exactly the same firewall rules as a standalone system would. </span> </p> 
   <p> <span __num="71" __label="true"> However, on a gateway there are additional things to do: </span> </p> 
   <ul> 
    <li> <span __num="72" __label="true"> you have other interfaces and need rules for them </span> </li> 
    <li> <span __num="73" __label="true"> packets emerging from ipsec processing must be correctly forwarded </span> </li> 
   </ul> 
   <p> <span __num="74" __label="true"> You need additional rules to handle these things. For example, adding some rules to the set shown above we get: </span> </p> 
   <pre><span __num="75" __label="true"># edit this line to match the interface you use as default route# ppp0 is correct for many modem, DSL or cable connections# but perhaps not for youworld=ppp0## edit these lines to describe your internal subnet and interfacelocalnet=42.42.42.0/24internal=eth1## allow IPsec## IKE negotiationsiptables -A INPUT  -p udp -i $world --sport 500 --dport 500 -j ACCEPTiptables -A OUTPUT -p udp -o $world --sport 500 --dport 500 -j ACCEPT# ESP encryption and authenticationiptables -A INPUT  -p 50 -i $world -j ACCEPTiptables -A OUTPUT -p 50 -o $world -j ACCEPT## packet forwarding for an IPsec gateway# simplest possible rules$ forward everything, with no attempt to filter## handle packets emerging from IPsec# ipsec+ means any of ipsec0, ipsec1, ...iptables -A FORWARD -d $localnet -i ipsec+ -j ACCEPT# simple rule for outbound packets# let local net send anything# IPsec will encrypt some of itiptables -A FORWARD -s $localnet -i $internal -j ACCEPT </span></pre> 
   <p> <span __num="76" __label="true"> On a production gateway, you would no doubt need tighter rules than the above. </span> </p> 
   <h2> <a name="resources"> <span __num="77"> Firewall resources </span> </a> </h2> 
   <p> <span __num="78"> For more information, see these handy resources: </span> </p> 
   <ul> 
    <li> <a href="http://www.netfilter.org/documentation/"> <span __num="79"> netfilter documentation </span> </a> </li> 
    <li> <span __num="80"> books such as: </span> 
     <ul> 
      <li> <span __num="81"> Cheswick and Bellovin, </span> <a href="biblio.html#firewall.book"> <span __num="82"> Firewalls and Internet Security </span> </a> </li> 
      <li> <span __num="83"> Zeigler, </span> <a href="biblio.html#Zeigler"> <span __num="84"> Linux Firewalls </span> </a> <span __num="85"> , </span> </li> 
     </ul> </li> 
    <li> <a href="firewall.html#firewall"> <span __num="86"> our firewalls document </span> </a> </li> 
    <li> <a href="web.html#firewall.web"> <span __num="87"> our firewall links </span> </a> </li> 
   </ul> 
   <a href="quickstart.html#quick.firewall"> <span __num="88"> Back to our quickstart guide. </span> </a> 
   <hr> 
   <a href="toc.html"> <span __num="89"> Contents </span> </a> 
   <a href="quickstart.html"> <span __num="90"> Previous </span> </a> 
   <a href="quickstart-configs.html"> <span __num="91"> Next </span> </a> 
  </text> 
 </body>
</html>